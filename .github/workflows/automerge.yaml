name: Auto Merge

on:
  workflow_run:
    workflows:
      - PR Check
    types:
      - completed

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Get Pull Request Info
      id: pr-info
      uses: actions/github-script@v6
      with:
        script: |
          const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
          if (!prNumber) {
            core.setFailed("No pull request associated with this workflow run.");
            return;
          }
          const pr = await github.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber,
          });
          return { prNumber, pr };

    - name: Check if PR is up-to-date
      id: check-up-to-date
      uses: actions/github-script@v6
      with:
        script: |
          const pr = JSON.parse(core.getInput('pr'));
          const baseBranch = process.env.BASE_BRANCH || pr.data.base.ref;
          const headBranch = pr.data.head.ref;

          const comparison = await github.repos.compareCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            base: baseBranch,
            head: headBranch,
          });

          if (comparison.data.behind_by > 0) {
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              body: `Please rebase your branch with ${baseBranch} before merging.`,
            });
            core.setOutput("upToDate", "false");
          } else {
            core.setOutput("upToDate", "true");
          }
        env:
          BASE_BRANCH: feature # Replace with your custom branch name
        with:
          pr: ${{ steps.pr-info.outputs.pr }}

    - name: Approve and Merge
      if: steps.check-up-to-date.outputs.upToDate == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const pr = JSON.parse(core.getInput('pr'));
          await github.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.data.number,
            body: `Thanks for the contribution, @${pr.data.user.login}!`,
          });

          await github.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.data.number,
            merge_method: "squash",
          });
        with:
          pr: ${{ steps.pr-info.outputs.pr }}